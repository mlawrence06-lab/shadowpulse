<?php
// Emergency Deploy Script
// Writes api/v1/get_page_context.php from Root

$target = __DIR__ . '/api/v1/get_page_context.php';

// Base64 of the final get_page_context.php (without debug)
$code = base64_decode('PD9waHANCi8vIGdldF9wYWdlX2NvbnRleHQucGhwDQovLyBNZWdhLUVuZHBvaW50OiBGZXRjaGVzIE1lbWJlciBTdGF0cyArIFRhcmdldCBWb3RlIFN1bW1hcnkgaW4gb25lIGdvLg0KDQpyZXF1aXJlIF9fRElSXX1IC4gJy9jb3JzLnBocCc7DQpoZWFkZXIoJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbicpOw0Kc2Vzc2lvbl9zdGFydCgpOw0KDQovLyAxLiBJbnB1dHMNCiRtZW1iZXJVdWlkID0gaXNzZXQoJF9HRVRbJ21lbWJlcl91dWlkJ10pID8gdHJpbSgkX0dFVVsnbWVtYmVyX3V1aWQnXSkgOiAnJzsNCiRjYXRlZ29yeSA9IGlzc2V0KCRfR0VUWydjYXRlZ29yeSddKSA/IHRyaW0oJF9HRVRbJ2NhdGVnb3J5J10pIDogJyc7DQokdGFyZ2V0SWQgPSBpc3NldCgkX0dFVVsndGFyZ2V0X2lkJ10pID8gKGludCkgJF9HRVRbJ3RhcmdldF9pZCddIDogMDsNCg0KaWYgKCR0YXJnZXRJZCA8PSAwIHx8IGVtcHR5KCRjYXRlZ29yeSkpIHsNCiAgICBlY2hvIGpzb25fZW5jb2RlKFsnT2snID0+IGZhbHNlLCAnZXJyb3InID0+ICdNaXNzaW5nIGZpZWxkcyddKTsNCiAgICBleGl0Ow0KfQ0KDQpyZXF1aXJlIF9fRElSXX1IC4gJy8uLi8uLi9jb25maWcvZGIucGhwJzsNCg0KdHJ5IHsNCiAgICAkcGRvID0gc3BfZ2V0X3BkbygpOw0KICAgIA0KICAgIC8vIDIuIENhbGwgU3RvcmVkIFByb2NlZHVyZQ0KICAgICRzdG10ID0gJHBkby0+cHJlcGFyZSgiQ0FMTCBzaGFkb3dwdWxzZV9nZXRfcGFnZV9jb250ZXh0KD8sID8sID8pIik7DQogICAgJHN0bXQtPmV4ZWN1dGUoWyRtZW1iZXJVdWlkLCAkY2F0ZWdvcnksICR0YXJnZXRJZF0pOw0KICAgIA0KICAgIC8vIDMuIEV4dHJhY3QgUmVzdWx0IFNldCAxOiBNZW1iZXIgU3RhdHMNCiAgICAkbWVtYmVyU3RhdHMgPSAkc3RtdC0+ZmV0Y2goUERPOjpGRVRDSF9BU1NPQyk7DQogICAgaWYgKCEkbWVtYmVyU3RhdHMpIHsNCiAgICAgICAgJG1lbWJlclN0YXRzID0gWyd0b3RhbF9wb2ludHMnID0+IDAsICdjYWxjdWxhdGVkX3JhbmsnID0+IDFdOw0KICAgIH0NCiAgICANCiAgICAvLyBNb3ZlIHRvIG5leHQgcmVzdWx0IHNldA0KICAgICRzdG10LT5uZXh0Um93c2V0KCk7DQogICAgDQogICAgLy8gNC4gRXh0cmFjdCBSZXN1bHQgU2V0IDI6IENvbnRleHQgKFZvdGUgU3VtbWFyeSkNCiAgICAkY29udGV4dCA9ICRzdG10LT5mZXRjaChQRE86OkZFVENIX0FTU09DKTsNCiAgICANCiAgICAvLyBGbHVzaCBhbnkgcmVtYWluaW5nIChqdXN0IGluIGNhc2UpDQogICAgZG8gew0KICAgICAgICAgLy8gZHJhaW4NCiAgICB9IHdoaWxlICgkc3RtdC0+bmV4dFJvd3NldCgpKTsNCiAgICAkc3RtdCA9IG51bGw7IC8vIENsb3NlDQogICAgDQogICAgLy8gNS4gU3RydWN0dXJlIFJlc3BvbnNlDQogICAgJHJlc3BvbnNlID0gWw0KICAgICAgICAnT2snID0+IHRydWUsDQogICAgICAgICdtZW1iZXJfc3RhdHMnID0+IFsNCiAgICAgICAgICAgICdyYW5rJyA9PiAoaW50KSAoJG1lbWJlclN0YXRzWydjYWxjdWxhdGVkX3JhbmsnXSA/PyAxKSwNCiAgICAgICAgICAgICdwb2ludHMnID0+IChpbnQpICgkbWVtYmVyU3RhdHNbJ3RvdGFsX3BvaW50cyddID8/IDApLA0KICAgICAgICAgICAgJ3RvcGljX3ZvdGVzJyA9PiAoaW50KSAoJG1lbWJlclN0YXRzWyd0b3BpY192b3RlcyddID8/IDApLA0KICAgICAgICAgICAgJ3Bvc3Rfdm90ZXMnID0+IChpbnQpICgkbWVtYmVyU3RhdHNbJ3Bvc3Rfdm90ZXMnXSA/PyAwKQ0KICAgICAgICBdLA0KICAgICAgICAnY29udGV4dCcgTz4gWw0KICAgICAgICAgICAgJ3VzZXJfdm90ZScgTz4gWw0KICAgICAgICAgICAgICAgICdlZmZlY3RpdmUnID0+IGlzc2V0KCRjb250ZXh0Wyd1c2VyX2VmZmVjdGl2ZSddKSA/IChpbnQpJHjb250ZXh0Wyd1c2VyX2VmZmVjdGl2ZSddIDogbnVsbCwNCiAgICAgICAgICAgICAgICAnZGVzaXJlZCcgTz4gaXNzZXQoJGNvbnRleHRbJ3VzZXJfZGVzaXJlZCddKSA/IChpbnQpJGNvbnRleHRbJ3VzZXJfZGVzaXJlZCddIDogbnVsbCwNCiAgICAgICAgICAgIF0sDQogICAgICAgICAgICAnc3VtbWFyeScgTz4gWw0KICAgICAgICAgICAgICAgICd2b3RlX2NvdW50JyA9PiAoaW50KSAoJGNvbnRleHRbJ3ZvdGVfY291bnQnXSA/PyAwKSwNCiAgICAgICAgICAgICAgICAnc2NvcmUnID0+IChmbG9hdCkgKCRjb250ZXh0WydhdmVyYWdlX3Njb3JlJ10gPz8gMCksDQogICAgICAgICAgICAgICAgJ2xhYmVsJyA9PiAkY29udGV4dlsndGFyZ2V0X2xhYmVsJ10gLy8gZS5nLiAiTXkgVG9waWMgVGl0bGUiDQogICAgICAgICAgICBdDQogICAgICAgIF0NCiAgICBdOw0KICAgIA0KICAgIGVjaG8ganNvbl9lbmNvZGUoJHJlc3BvbnNlKTsNCiAgICANCiAgICAvLyA2LiBCYWNrZ3JvdW5kIFF1ZXVlIChQaWdneWJhY2spDQogICAgaWYgKGZ1bmN0aW9uX2V4aXN0cygnZmFzdGNnaV9maW5pc2hfcmVxdWVzdCcpKSB7DQogICAgICAgIGZhc3RjZ2lfZmluaXNoX3JlcXVlc3QoKTsNCiAgICB9DQogICAgDQogICAgdHJ5IHsNCiAgICAgICAgcmVxdWlyZV9vbmNlIF9fRElSX18gLiAnLy4uLy4u/Y29yZS9xdXB1ZV9ydW5uZXIucGhwJzsNCiAgICAgICAgaWYgKGZ1bmN0aW9uX2V4aXN0cygncnVuX25pbmphX3F1ZXVlJykpIHsNCiAgICAgICAgICAgIHJ1bl9uaW5qYV9xdWV1ZSgkcGRvKTsNCiAgICAgICAgfQ0KICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiAkZSkge30NCg0KfSBjYXRjaCAoVGhyb3dhYmxlICRlKSB7DQogICAgaHR0cF9yZXNwb25zZV9jb2RlKDUwMCk7DQogICAgZWNobyBqc29uX2VuY29kZShbJ29rJyA9PiBmYWxzZSwgJ2Vycm9yJyA9PiAkZS0+Z2V0TWVzc2FnZSgpXSk7DQp9DQo/Pg==');

if (!$code) {
    die("Base64 Decode Failed");
}

if (file_put_contents($target, $code)) {
    echo "Successfully deployed to $target (" . strlen($code) . " bytes)";
} else {
    echo "Failed to write to $target";
}
?>